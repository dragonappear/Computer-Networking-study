# 네트워크 계층

네트워크 계층은 서로 상호작용하는 `데이터 평면(data plane)` 과 `제어 평면(control plane)` 두 부분으로 나눌 수 있다.

_라우터별 제어(per-router)_ 라는 네트워크 계층 기능은 한 라우터의 입력 링크에 도착한 데이터그램이 다른 한 목적 라우터의 출력 링크에 어떻게 도달하는지를 결정한다.

> 데이터 그램 : 네트워크 계층의 패킷 단위

각 라우터의 데이터 평면 역할은 입력 링크에서 출력 링크로 데이터그램을 전달하는 것이다.

<br />
<br />

## 포워딩과 라우팅

- 포워딩(전달) : 패킷이 라우터에 입력 링크에 도착했을 때 라우터는 그 패킷을 적절한 출력 링크로 전달해야 한다.

- 라우팅 : 송신자가 수신자에게 패킷을 전송할 때 네트워크 계층은 패킷 경로를 결정해야 한다. 이러한 경로를 계산하는 알고리즘을 `라우팅 알고리즘` 이라 한다.

<br />
<br />

## 라우터 내부에는 무엇이 있을까?

라우터의 네 가지 요소를 알아보자.

### 입력 포트(input port)

- 라우터의 물리 계층과 데이터 링크 계층의 기능을 수행한다.
- 프레임을 역캡슐화 해서 패킷을 추출하고, 오류를 검사하여 훼손된 경우 패킷을 폐기한다.
- 물리 계층 프로세서와 데이터 링크 계층 프로세서 외에 입력 포트는 스위칭 패브릭에 직접 전달되기 전, 패킷을 보관하기 위한 버퍼(큐)를 가진다.
- 여기서에 포트는 물리적인 입출력 라우터 인터페이스를 의미한다.(소프트웨어적인 포트랑 다름)

### 스위치 구조

- 스위치 구조는 라우터의 입력 포트와 출력 포트를 연결한다.
- 스위치 구조는 라우터 내부에 포함되어 있다.

### 출력 포트(output port)

- 출력 포트는 입력포트와 같은 기능을 수행하지만 이를 역순으로 수행한다.
- 출력될 패킷이 큐에 들어오면 각 패킷은 프레임으로 캡슐화가 되고, 최종적으로 물리 계층에서 프레임을 전기적으로 생성하여 전송된다.

### 라우팅 프로세서(Routing Processor)

- 네트워크 계층의 기능을 수행한다.
- 패킷을 전송할 출력 포트 번호와 다음 홉 주소를 찾기 위해 패킷의 주소를 참조한다.
- 라우팅 프로세서가 포워딩 테이블에서 검색하기 때문에 이런 동작은 테이블 검색으로도 알려져있다.

### 스위칭 패브릭(Switching Fabrics)

- 패킷을 입력 큐에서 출력 큐로 전달하는 일

<br />
<br />
<br />

# 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

인터넷 네트워크 계층 패킷을 데이터그램 이라고 한다.

IPv4 데이터그램 포맷

![다운로드](https://user-images.githubusercontent.com/103870198/216826128-2a6be40a-9729-40ec-8bdb-38509a6a93f1.png)

- 버전 :
  - 4비트로 IP 버전을 명시한다(v4, v6)

<br />

- 헤더 길이 :
  - IPv4는 헤더에 가변 길이의 옵션을 포함하므로 4비트로 실제 페이로드가 시작하는 곳을 결정한다.
  - 대부분의 IPv4 데이터그램은 옵션을 포함하지 않으므로 20바이트이다.

<br />

- 서비스타입(TOS) :
  - 어떤 네트워크 서비스를 담고 있는지 구분한다
  - ex) 실시간(VoIP)과 비실시간(FTP)를 구분한다.
  - TOS 비트 중 2비트는 명시적 혼잡 알림(ECN)에 사용 된다.

<br />

- 데이터 그램 길이 :
  - 바이트로 계산한 IP 데이터그램의 헤더를 포함한 전체 길이
  - 16비트로 이론상 65535바이트까지 가능하지만 대부분 1500바이트 이하이다.

<br />

- 식별자, 플래스, 단편화 오프셋 :
  - IP 단편화와 관련된 필드
  - IPv6에서는 단편화를 허용하지 않는다.

<br />

- TTL(Time-To-Live) :
  - 패킷이 네트워크에서 무한히 순환하지 않도록 한다.(라우팅 루프)
  - TTL 필드가 0이 되면 라우터가 데이터그램을 폐기한다.

<br />

- 프로토콜 :
  - IP 데이터그램이 최종 목적지에 도착했을 때 사용된다.
  - 목적지의 트랜스포트 계층 프로토콜을 명시한다(TCP/UDP)

<br />

- 헤더 체크섬 :
  - 수신한 IP 데이터그램의 비트 오류를 탐지하는데 도움을 준다.
  - 라우터는 수신한 각 IP 패킷마다 헤더 체크섬을 계산하여 비교한다.

<br />

- 출발지와 목적지 IP 주소 :
  - 출발지와 목적지의 IP 주소를 필드에 삽입한다.

<br />

- 옵션 :
  - 옵션 필드는 IP 헤더를 확장한다.
  - 사용하지 않는다.

<br />

- 데이터(payload) :
  - 데이터그램이 존재하는 이유이자 가장 중요한 마지막 필드이다.
  - IP 데이터그램의 데이터 필드는 목적지에 전달하기 위해 트랜스포트 계층 세그먼트(TCP/UDP)를 포함하지만 ICMP 같은 유형의 데이터를 담기도 한다.

<br />
<br />

## 서브넷(Subnet)

![다운로드 (2)](https://user-images.githubusercontent.com/103870198/216827085-a1d0bb84-a719-44f6-bee5-5e812a17d598.png)

- 서브넷은 라우터를 거치지 않고 물리적으로 연결된 인터페이스 네트워크로, 라우터와 호스트 사이의 영역이다.

- 위 그림의 푸른 색으로 칠해진 부분이 각각 하나의 서브넷이다.
- 왼쪽 위 서브넷을 보면 223.1.1.x의 주소를 가지는데 상위 24비트는 서브넷을 위한 주소이다.
- 서브넷 주소 뒤에 /24와 같은 수가 붙어있는데 이걸 `subnet mask` 라 한다. 상위 24비트까지가 서브넷 주소임을 표기한다. 이를 _CIDR 표기법_ 이라 한다.

<br />
<br />

## IP 주소 체계: CIDR(Classless InterDomain Routing)

![다운로드 (3)](https://user-images.githubusercontent.com/103870198/216827172-325ca6ba-b809-44f5-9ffb-f5b8b9f1ae9c.png)

<br />
<br />

## 동적 호스트 구성 프로토콜: DHCP

호스트에 IP 주소를 할당하는 것은 네트워크 관리자가 고정된 주소를 부여하거나, 동적으로 서브넷 내에서 IP 주소를 할당해주는 방법이 있다.

일반적으로 <b>`DHCP(Dynamic Host Configuration Protocol)`</b>을 더 많이 사용한다.

DHCP는 호스트가 IP 주소를 자동으로 할당받게 해주며

이런 능력 때문에 `플러그 앤 플레이 프로토콜` 또는

`제로 구성 프로토콜` 이라고도 한다.

DHCP의 동작방식

![다운로드 (4)](https://user-images.githubusercontent.com/103870198/216827435-d6be306c-f63a-41bb-b76a-2b0afdc8df3c.png)

- DHCP 서버 발견 :

  새롭게 도착한 호스트는 DHCP를 발견하는 `DHCP 발견 메시지`를 사용하여 UDP 패킷을 보낸다.

  이를 IP 데이터그램으로 캡슐화된다.

  클라이언트 DHCP 는 서버 주소와 자신의 주소 마저 모르기 때문에 목적지 IP 주소를 브로드캐스트 255.255.255.255로 설정하며 출발지 IP 주소를 0.0.0.0 으로 설정하여 보낸다.

  이 메시지는 서브넷에 모든 노드에 브로드캐스트 된다.

- DHCP 서버 제공 :

  DHCP 메시지를 받은 DHCP 서버는 `DHCP 제공 메시지`를 클라이언트에게 응답한다.

  이때 목적지 IP 주소를 255.255.255.255 로 설정하여 브로드캐스트 하는데 이유는 서브넷에 여러 DHCP 서버가 존재하기 때문에 클라이언트가 여러 서버 중 최적의 서버를 선택하도록 하기 위함이다.

  클라이언트에게 제공될 IP 주소, 네트워크 마스크, IP 주소 임대기간을 포함한다.

- DHCP 요청 :

  새롭게 도착한 클라이언트는 하나 또는 그 이상의 서버 제공자를 선택하고 파라미터 설정으로 되돌아오는 DHCP 요청 메시지로 응답하여 주소 할당을 요청한다.

- DHCP ACK :

  서버는 DHCP 요청 메시지에 대해 요청된 파라미터를 확인하는 DHCP ACK 메시지로 응답한다.

<br />
<br />

## 네트워크 주소 변환 : NAT

주로 사설 내부망에서 외부망과의 통신을 위해서 네트워크 주소 변환(NAT)를 사용한다.

<br />
<br />

## IPv6

![다운로드 (5)](https://user-images.githubusercontent.com/103870198/216828006-d822c4ec-f83a-48fe-984d-4c0c37b11de1.png)

- IPv4 프로토콜의 다음 버전
- 32비트 주소 쳬계인 IPv4의 주소 공간이 빠르게 고갈되어 필요성이 생김
- v4와 달리 헤더가 간소화 되었다.
  - no checksum
  - no fragmentaion / reassembly
  - no options

<br />
<br />
<br />

<hr >

질문 :

q1. 네트워크 계층에 대해 아는대로 설명해주세요

네트워크 계층은 라우터 장비를 사용해서 데이터를 목적지까지 가장 안전하고 빠르게 전달하는 역할을 담당합니다.

q2. IPv4와 IPv6에 대해 아는대로 설명해주세요

IPv4는 인터넷 프로토콜의 4번째 버전입니다.

32비트로 구성되어있고 IPv4 주소체계의 주소가 점점 고갈되감에 따라서 6번째 버전인 IPv6가 등장하게 되었습니다.

IPv6는 128비트의 주소체계를 가지고 있고 IPv4의 주소부족 문제를 해결하고
보안적으로 강화되었다고 알고 있습니다.

참고자료 :

https://uzun.dev/178?category=1068573

https://nenunena.tistory.com/52
